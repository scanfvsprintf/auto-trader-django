# 管理端设计文档（web_manager + autoTrade_web）

## 目标与范围
- 为量化交易系统新增统一的管理端，提供选股管理、日线管理、因子管理、系统管理等功能。
- 后端：新增 Django 应用 `web_manager`，提供前后端交互 API（基于 Django 原生视图 + 简单 JSON 返回）。
- 前端：新增 `autoTrade_web`（Vue2 + ElementUI + ECharts），采用最朴素写法、少语法糖、注释充分，移动端与桌面端自适应。
- 登录：前端假登录，不经后端；允许用户名 `xiangyangxin`/`xiangmei`，密码 `123456`。

## 总体架构
- Django 提供 REST 风格 API，路径前缀 `/webManager/`；跨域通过 Nginx 或 Django 开发模式下的同域访问。
- 前端静态站点与后端解耦部署（同域或不同域均可）。
- 安全简化：无后端认证，前端本地校验；后端对危险操作（schema 删除）做参数校验与幂等保护。

## 数据模型映射（关键表）
- 选股计划：`tb_daily_trading_plan` → 模型 `DailyTradingPlan`
- 股票主表：`tb_stock_info` → 模型 `StockInfo`
- 日线：`tb_daily_quotes` → 模型 `DailyQuotes`
- 沪深300：`tb_index_quotes_csi300` → 模型 `IndexQuotesCsi300`
- 因子定义：`tb_factor_definitions` → 模型 `FactorDefinitions`
- 因子值：`tb_daily_factor_values` → 模型 `DailyFactorValues`
- 策略参数：`tb_strategy_parameters` → 模型 `StrategyParameters`

## API 设计（/webManager 前缀）
说明：全部返回 JSON，统一结构：`{"code":0,"msg":"ok","data":...}`；失败 `code!=0`，`msg` 给出错误说明。

1) 选股管理
- GET `/selection/plans?date=YYYY-MM-DD`：查询某天的选股表（含股票名称、miop/maop/final_score/rank）。
- GET `/selection/factors?date=YYYY-MM-DD&stock=sh.600000`：查询该股当日的因子值（含原始值、标准分）。
- POST `/selection/run`：手动发起一天选股，参数：`date`、`send_mail`（bool）。

2) 日线管理
- GET `/daily/csi300?start=YYYY-MM-DD&end=YYYY-MM-DD&with_m=0|1`：查询沪深300日线，供前端绘制 K 线；可选返回 M 值。
- POST `/daily/csi300/fetch`：补获取沪深300指数数据，参数：`start`、`end`。
- GET `/daily/stock?code=sh.600000&start=YYYY-MM-DD&end=YYYY-MM-DD&ma=5,10,20&with_vol=1&with_amt=1&with_m=1`：单股 K 线及可选均线/成交量/成交额/M 值。
- POST `/daily/fetch`：日线数据补拉，参数：`codes`（数组或"ALL"）、`start`、`end`；附加：`fill_missing_for_date=YYYY-MM-DD` 查主表存在但当日日线缺失的代码并尝试补拉。
- GET `/daily/m_value?start=YYYY-MM-DD&end=YYYY-MM-DD`：查询区间内选股模块生成的 M 值，返回用于统计图的数据。

3) 因子管理
- 因子参数 CRUD：`/factors/params [GET/POST/PUT/DELETE]`
- 因子定义 CRUD：`/factors/definitions [GET/POST/PUT/DELETE]`

4) 系统管理
- DELETE `/system/schema?name=xxx`：删除指定回测 schema（仅限允许名单，避免误删生产）。
- GET `/system/backtest/results?schema=xxx`：查询回测结果；后端根据 schema 动态判断类别（普通回测或 M 值单策略回测）。

## 后端实现细节（Django）
- 新建 `web_manager` 应用，`urls.py` 以模块化子路由组织（selection/daily/factors/system）。
- 仅使用 Django 原生 `JsonResponse`，避免过度依赖三方；查询使用 ORM 与聚合。
- 严格幂等：所有“补拉/发起任务”均可重复执行，不产生重复脏数据。
- 日志：沿用项目 logging 配置，接口错误统一捕获并记录。

### 关键 ORM 说明
- 选股查询：`DailyTradingPlan.objects.filter(plan_date=...).select_related('stock_code')`，返回 `rank/stock_code/stock_name/miop/maop/final_score`。
- 因子查询：`DailyFactorValues.objects.filter(stock_code=..., trade_date=...)` 与 `FactorDefinitions` 联查。
- 指数/个股 K 线：`IndexQuotesCsi300`、`DailyQuotes` 区间查询。
- M 值：读取 `DailyFactorValues` 中 `factor_code='dynamic_M_VALUE'`（`stock_code_id='_MARKET_REGIME_INDICATOR_'`）。

## 前端结构（autoTrade_web）
- 技术栈：Vue2 + VueRouter + Axios + ElementUI + ECharts。
- 目录：
  - `public/`：index.html
  - `src/`
    - `main.js`：应用入口，注册 ElementUI 与路由
    - `router.js`：前端路由，路由守卫（本地假登录）
    - `api/`：封装最简单的 axios 方法（无拦截器魔法）
    - `views/`
      - `Login.vue`：本地假登录
      - `Layout.vue`：统一布局（顶部导航 + 左侧菜单），响应式
      - `Selection.vue`：选股管理（查询/悬浮因子/手动发起）
      - `Daily.vue`：日线管理（指数/个股K线/补拉/M值）
      - `Factors.vue`：因子管理（参数/定义 CRUD）
      - `System.vue`：系统管理（schema 删除/回测查询）
    - `components/`：通用表格、K线图组件、表单组件
    - `styles/`：主题与自适应样式（尽量统一 UI 风格）

- 响应式方案：
  - 使用 `flex` + 百分比宽度，少用复杂断点；针对手机端在表格列上做精简显示；ECharts 自适应容器尺寸。

## 交互与状态
- 登录：用户名 `xiangyangxin` 或 `xiangmei` 且密码 `123456` 即写入 `localStorage` 标记已登录。
- 路由守卫：未登录跳转登录页；已登录进入各模块；权限可按用户名做简单分流（例如 `xiangmei` 只读）。
- 错误提示：统一 `this.$message.error(msg)`；成功 `this.$message.success()`。

## 权限与风险控制（轻量）
- 后端危险操作白名单与参数校验；删除 schema 仅允许测试 schema。
- 任务接口需要明确日期范围与股票代码；默认限制最大天数。

## 里程碑
1. 设计文档与骨架搭建
2. 选股管理接口与前端页
3. 日线管理核心（指数/个股）
4. 数据补拉与 M 值可视化
5. 因子/系统管理

## 测试与验收
- 后端：接口单测覆盖关键路径（时间范围、多代码、多日）
- 前端：E2E 手工走查与移动端自测；对慢查询做分页与懒加载。

## 部署
- 前端构建后静态托管（Nginx/静态桶）；后端按原项目部署流程。
- 推荐同域部署以免 CORS 问题，或在 Nginx 配置反向代理。
